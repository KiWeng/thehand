import * as THREE from "three"
import { SkeletonHelper } from "three"

// TODO: inherit from threejs object maybe?
export class Hand {
    static right_hand_open = [
        // # Position{HmdVector4_t} (x,y,z,1) , Quaternion{HmdQuaternionf_t} (w,x,y,z)
        // # https://github.com/ValveSoftware/openvr/issues/505
        [
            [0.0, 0.0, 0.0, 1.0],
            [1.0, -0.0, -0.0, 0.0],
        ],
        // # 0 - Root Node, Dan Skipped the Ref:Root
        [
            [0.034038, 0.036503, 0.164722, 1.0],
            [-0.055147, -0.078608, 0.920279, -0.379296],
        ],
        // # 2 - Wrist
        [
            [0.012083, 0.02807, 0.02505, 1.0],
            [0.567418, -0.464112, 0.623374, -0.272106],
        ],
        // # Thumb Meta
        [
            [-0.040406, -0.0, 0.0, 1.0],
            [0.994838, 0.082939, 0.019454, 0.05513],
        ],
        [
            [-0.032517, -0.0, -0.0, 1.0],
            [0.974793, -0.003213, 0.021867, -0.222015],
        ],
        [
            [-0.030464, 0.0, 0.0, 1.0],
            [1.0, -0.0, -0.0, 0.0],
        ],
        [
            [-0.000632, 0.026866, 0.015002, 1.0],
            [0.421979, -0.644251, 0.422133, 0.478202],
        ],
        // # Index Meta
        [
            [-0.074204, 0.005002, -0.000234, 1.0],
            [0.995332, 0.007007, -0.039124, 0.087949],
        ],
        [
            [-0.04393, 0.0, 0.0, 1.0],
            [0.997891, 0.045808, 0.002142, -0.045943],
        ],
        [
            [-0.028695, -0.0, -0.0, 1.0],
            [0.999649, 0.00185, -0.022782, -0.013409],
        ],
        [
            [-0.022821, -0.0, 0.0, 1.0],
            [1.0, -0.0, 0.0, -0.0],
        ],
        [
            [-0.002177, 0.00712, 0.016319, 1.0],
            [0.541276, -0.546723, 0.460749, 0.44252],
        ],
        // # Middle Meta
        [
            [-0.070953, -0.000779, -0.000997, 1.0],
            [0.980294, -0.167261, -0.078959, 0.069368],
        ],
        [
            [-0.043108, -0.0, -0.0, 1.0],
            [0.997947, 0.018493, 0.013192, 0.059886],
        ],
        [
            [-0.033266, -0.0, -0.0, 1.0],
            [0.997394, -0.003328, -0.028225, -0.066315],
        ],
        [
            [-0.025892, 0.0, -0.0, 1.0],
            [0.999195, -0.0, 0.0, 0.040126],
        ],
        [
            [-0.000513, -0.006545, 0.016348, 1.0],
            [0.550143, -0.516692, 0.429888, 0.495548],
        ],
        // # Ring Meta
        [
            [-0.065876, -0.001786, -0.000693, 1.0],
            [0.99042, -0.058696, -0.10182, 0.072495],
        ],
        [
            [-0.040697, -0.0, -0.0, 1.0],
            [0.999545, -0.00224, 0.000004, 0.030081],
        ],
        [
            [-0.028747, 0.0, 0.0, 1.0],
            [0.999102, -0.000721, -0.012693, 0.04042],
        ],
        [
            [-0.02243, 0.0, -0.0, 1.0],
            [1.0, 0.0, 0.0, 0.0],
        ],
        [
            [0.002478, -0.018981, 0.015214, 1.0],
            [0.52394, -0.526918, 0.32674, 0.584025],
        ],
        // # Pinky Meta
        [
            [-0.062878, -0.002844, -0.000332, 1.0],
            [0.986609, -0.059615, -0.135163, 0.069132],
        ],
        [
            [-0.03022, -0.0, -0.0, 1.0],
            [0.994317, 0.001896, -0.000132, 0.106446],
        ],
        [
            [-0.018187, -0.0, -0.0, 1.0],
            [0.995931, -0.00201, -0.052079, -0.073526],
        ],
        [
            [-0.018018, -0.0, 0.0, 1.0],
            [1.0, 0.0, 0.0, 0.0],
        ],
        // # https://github.com/ValveSoftware/openvr/wiki/Hand-Skeleton#auxiliary-bones
        [
            [0.006059, 0.056285, 0.060064, 1.0],
            [0.737238, 0.202745, -0.594267, -0.249441],
        ],
        // # thumb aux
        [
            [0.040416, -0.043018, 0.019345, 1.0],
            [-0.290331, 0.623527, 0.663809, 0.293734],
        ],
        // # index aux
        [
            [0.039354, -0.075674, 0.047048, 1.0],
            [-0.187047, 0.678062, 0.659285, 0.265683],
        ],
        // # middle aux
        [
            [0.03834, -0.090987, 0.082579, 1.0],
            [-0.183037, 0.736793, 0.634757, 0.143936],
        ],
        // # ring aux
        [
            [0.031806, -0.087214, 0.121015, 1.0],
            [-0.003659, 0.758407, 0.639342, 0.126678],
        ],
        // # pinky aux
    ]
    static right_fist_pose = [
        [
            [0.0, 0.0, 0.0, 1.0],
            [1.0, -0.0, -0.0, 0.0],
        ],
        [
            [0.034038, 0.036503, 0.164722, 1.0],
            [-0.055147, -0.078608, 0.920279, -0.379296],
        ],
        // # 2 - Wrist
        [
            [0.016305, 0.027529, 0.0178, 1.0],
            [0.483332, -0.225703, 0.836342, -0.126413],
        ],
        // # Thumb meta
        [
            [-0.040406, -0.0, 0.0, 1.0],
            [0.894335, -0.013302, -0.082902, 0.439448],
        ],
        [
            [-0.032517, -0.0, -0.0, 1.0],
            [0.842428, 0.000655, 0.001244, 0.538807],
        ],
        [
            [-0.030464, 0.0, 0.0, 1.0],
            [1.0, -0.0, -0.0, 0.0],
        ],
        [
            [-0.003802, 0.021514, 0.012803, 1.0],
            [0.395174, -0.617314, 0.449185, 0.510874],
        ],
        [
            [-0.074204, 0.005002, -0.000234, 1.0],
            [0.737291, -0.032006, -0.115013, 0.664944],
        ],
        [
            [-0.043287, 0.0, 0.0, 1.0],
            [0.611381, 0.003287, 0.003823, 0.791321],
        ],
        [
            [-0.028275, -0.0, -0.0, 1.0],
            [0.745388, -0.000684, -0.000945, 0.666629],
        ],
        [
            [-0.022821, -0.0, 0.0, 1.0],
            [1.0, -0.0, 0.0, -0.0],
        ],
        [
            [-0.005787, 0.006806, 0.016534, 1.0],
            [0.522315, -0.514203, 0.4837, 0.478348],
        ],
        [
            [-0.070953, -0.000779, -0.000997, 1.0],
            [0.723653, -0.097901, 0.048546, 0.681458],
        ],
        [
            [-0.043108, -0.0, -0.0, 1.0],
            [0.637464, -0.002366, -0.002831, 0.770472],
        ],
        [
            [-0.033266, -0.0, -0.0, 1.0],
            [0.658008, 0.00261, 0.003196, 0.753],
        ],
        [
            [-0.025892, 0.0, -0.0, 1.0],
            [0.999195, -0.0, 0.0, 0.040126],
        ],
        [
            [-0.004123, -0.006858, 0.016563, 1.0],
            [0.523374, -0.489609, 0.463997, 0.520644],
        ],
        [
            [-0.065876, -0.001786, -0.000693, 1.0],
            [0.75997, -0.055609, 0.011571, 0.647471],
        ],
        [
            [-0.040331, -0.0, -0.0, 1.0],
            [0.664315, 0.001595, 0.001967, 0.747449],
        ],
        [
            [-0.028489, 0.0, 0.0, 1.0],
            [0.626957, -0.002784, -0.003234, 0.779042],
        ],
        [
            [-0.02243, 0.0, -0.0, 1.0],
            [1.0, 0.0, 0.0, 0.0],
        ],
        [
            [-0.001131, -0.019295, 0.015429, 1.0],
            [0.477833, -0.479766, 0.379935, 0.630198],
        ],
        [
            [-0.062878, -0.002844, -0.000332, 1.0],
            [0.827001, 0.034282, 0.00344, 0.561144],
        ],
        [
            [-0.029874, -0.0, -0.0, 1.0],
            [0.702185, -0.006716, -0.009289, 0.711903],
        ],
        [
            [-0.017979, -0.0, -0.0, 1.0],
            [0.676853, 0.007956, 0.009917, 0.736009],
        ],
        [
            [-0.018018, -0.0, 0.0, 1.0],
            [1.0, 0.0, 0.0, 0.0],
        ],
        [
            [-0.019716, 0.002802, 0.093937, 1.0],
            [0.377286, -0.540831, -0.150446, 0.736562],
        ],
        [
            [-0.000171, 0.016473, 0.096515, 1.0],
            [-0.006456, 0.022747, 0.932927, 0.359287],
        ],
        [
            [-0.000448, 0.001536, 0.116543, 1.0],
            [-0.039357, 0.105143, 0.928833, 0.353079],
        ],
        [
            [-0.003949, -0.014869, 0.130608, 1.0],
            [-0.055071, 0.068695, 0.944016, 0.317933],
        ],
        [
            [-0.003263, -0.034685, 0.139926, 1.0],
            [0.01969, -0.100741, 0.957331, 0.270149],
        ],
    ]
    static right_fist_pose2 = [
        [
            [0.0, 0.0, 0.0, 1.0],
            [-6.123234e-17, 1, 6.123234e-17, -4.371139e-8],
        ],
        [
            [-0.034037687, 0.03650266, 0.16472164, 1],
            [-0.078608155, -0.92027926, 0.3792963, -0.055146642],
        ],
        [
            [-0.016305087, 0.027528726, 0.017799662, 1],
            [-0.2257035, -0.836342, 0.12641343, 0.48333195],
        ],
        [
            [0.040405963, -5.1561553e-8, 4.5447194e-8, 1],
            [-0.01330204, 0.0829018, -0.43944824, 0.89433527],
        ],
        [
            [0.032516792, -5.1137583e-8, -1.2933195e-8, 1],
            [0.00072834245, -0.0012028969, -0.58829284, 0.80864674],
        ],
        [
            [0.030463902, 1.6269207e-7, 7.92839e-8, 1],
            [-1.3877788e-17, -1.3877788e-17, -5.551115e-17, 1],
        ],
        [
            [0.0038021489, 0.021514187, 0.012803366, 1],
            [-0.6173145, -0.44918522, -0.5108743, 0.39517453],
        ],
        [
            [0.074204385, 0.005002201, -0.00023377323, 1],
            [-0.041852362, 0.11180638, -0.72633374, 0.67689514],
        ],
        [
            [0.043286677, 5.9333324e-8, 1.8320057e-7, 1],
            [-0.0005700487, 0.115204416, -0.81729656, 0.56458294],
        ],
        [
            [0.028275194, -9.297885e-8, -1.2653295e-7, 1],
            [-0.010756178, 0.027241308, -0.66610956, 0.7452787],
        ],
        [
            [0.022821384, -1.4365155e-7, 7.651614e-8, 1],
            [6.938894e-18, 1.9428903e-16, -1.348151e-33, 1],
        ],
        [
            [0.005786922, 0.0068064053, 0.016533904, 1],
            [-0.5142028, -0.4836996, -0.47834843, 0.522315],
        ],
        [
            [0.07095288, -0.00077883265, -0.000997186, 1],
            [-0.09487112, -0.05422859, -0.7229027, 0.68225396],
        ],
        [
            [0.043108486, -9.950596e-8, -6.7041825e-9, 1],
            [0.0076794685, -0.09769542, -0.7635977, 0.6382125],
        ],
        [
            [0.03326598, -1.7544496e-8, -2.0628962e-8, 1],
            [-0.06366954, 0.00036316764, -0.7530614, 0.6548623],
        ],
        [
            [0.025892371, 9.984198e-8, -2.0352908e-9, 1],
            [1.1639192e-17, -5.602331e-17, -0.040125635, 0.9991947],
        ],
        [
            [0.004123044, -0.0068582613, 0.016562859, 1],
            [-0.489609, -0.46399677, -0.52064353, 0.523374],
        ],
        [
            [0.06587581, -0.0017857892, -0.00069344096, 1],
            [-0.088269405, 0.012672794, -0.7085384, 0.7000152],
        ],
        [
            [0.040331207, -9.449958e-8, -2.273692e-8, 1],
            [-0.0005935501, -0.039828163, -0.74642265, 0.66427904],
        ],
        [
            [0.028488781, 1.01152565e-7, 4.5493586e-8, 1],
            [-0.027121458, -0.005438834, -0.7788164, 0.62664175],
        ],
        [
            [0.022430236, 1.0846127e-7, -1.7428562e-8, 1],
            [6.938894e-18, -9.62965e-35, -1.3877788e-17, 1],
        ],
        [
            [0.0011314574, -0.019294508, 0.01542875, 1],
            [-0.47976637, -0.37993452, -0.63019824, 0.47783276],
        ],
        [
            [0.0628784, -0.0028440945, -0.0003315112, 1],
            [-0.094065815, 0.062634066, -0.69046116, 0.7144873],
        ],
        [
            [0.029874247, -3.4247638e-8, -9.126629e-8, 1],
            [0.00313052, 0.03775632, -0.7113834, 0.7017823],
        ],
        [
            [0.017978692, -2.8448923e-9, -2.0797508e-7, 1],
            [-0.008087321, -0.003009417, -0.7361885, 0.6767216],
        ],
        [
            [0.01801794, -2.00012e-8, 6.59746e-8, 1],
            [0, 0, 1.9081958e-17, 1],
        ],
        [
            [0.019716311, 0.002801723, 0.093936935, 1],
            [-0.54886997, 0.1177861, -0.7578353, 0.33249632],
        ],
        [
            [-0.0075385696, 0.01764465, 0.10240429, 1],
            [0.13243657, -0.8730836, -0.45493412, -0.114980996],
        ],
        [
            [-0.0031984635, 0.0072115273, 0.11665362, 1],
            [0.17098099, -0.92266804, -0.34507802, -0.019245595],
        ],
        [
            [2.6269245e-5, -0.007118772, 0.13072418, 1],
            [0.15011512, -0.952169, -0.25831383, -0.064137466],
        ],
        [
            [-0.0018780098, -0.02256182, 0.14003526, 1],
            [0.07684197, -0.97957754, -0.18576658, -0.0037347008],
        ],
    ]
    hand_model
    bones = []
    skeletonHelpers = []

    constructor(hand_model, data) {
        this.hand_model = hand_model
        this.data = data

        let root = hand_model.children[0].children[0]
        this.bones.push(
            root, // root
            root.children[0],
            root.children[0].children[0], // thumb0
            root.children[0].children[0].children[0], // thumb1
            root.children[0].children[0].children[0].children[0], // thumb2
            root.children[0].children[0].children[0].children[0].children[0], // thumb3
            root.children[0].children[1], // indexfinger0
            root.children[0].children[1].children[0],
            root.children[0].children[1].children[0].children[0],
            root.children[0].children[1].children[0].children[0].children[0],
            root.children[0].children[1].children[0].children[0].children[0]
                .children[0], //indexfinger4
            root.children[0].children[2], // middlefinger0
            root.children[0].children[2].children[0],
            root.children[0].children[2].children[0].children[0],
            root.children[0].children[2].children[0].children[0].children[0],
            root.children[0].children[2].children[0].children[0].children[0]
                .children[0], // middlefinger4
            root.children[0].children[3], // ringfinger0
            root.children[0].children[3].children[0],
            root.children[0].children[3].children[0].children[0],
            root.children[0].children[3].children[0].children[0].children[0],
            root.children[0].children[3].children[0].children[0].children[0]
                .children[0], // ringfinger4
            root.children[0].children[4], // pinkyfinger0
            root.children[0].children[4].children[0],
            root.children[0].children[4].children[0].children[0],
            root.children[0].children[4].children[0].children[0].children[0],
            root.children[0].children[4].children[0].children[0].children[0]
                .children[0], //pinkyfinger4
            root.children[1], //auxthumb
            root.children[2],
            root.children[3],
            root.children[4],
            root.children[5]
        ) //auxpinky
    }

    lerpThumb(t) {
        this.lerp(t, [1, 2, 3, 4, 5])
    }

    lerpIndex(t) {
        this.lerp(t, [6, 7, 8, 9, 10])
    }

    lerpMiddle(t) {
        this.lerp(t, [11, 12, 13, 14, 15])
    }

    lerpRing(t) {
        this.lerp(t, [16, 17, 18, 19, 20])
    }

    lerpPinky(t) {
        this.lerp(t, [21, 22, 23, 24, 25])
    }

    updateHandPose(frameIndex) {
        try {
            this.lerpThumb(parseFloat(this.data[frameIndex][0]) / 16)
            this.lerpIndex(parseFloat(this.data[frameIndex][1]) / 16)
            this.lerpMiddle(parseFloat(this.data[frameIndex][2]) / 16)
            this.lerpRing(parseFloat(this.data[frameIndex][3]) / 16)
            this.lerpPinky(parseFloat(this.data[frameIndex][4]) / 16)
        } catch (e) {
            console.error(e)
        }
    }

    lerp(t, joints) {
        for (let i of joints) {
            let open_quaternion = new THREE.Quaternion(
                Hand.right_hand_open[i][1][1],
                Hand.right_hand_open[i][1][2],
                Hand.right_hand_open[i][1][3],
                Hand.right_hand_open[i][1][0]
            )
            let fist_quaternion = new THREE.Quaternion(
                Hand.right_fist_pose[i][1][1],
                Hand.right_fist_pose[i][1][2],
                Hand.right_fist_pose[i][1][3],
                Hand.right_fist_pose[i][1][0]
            )
            this.bones[i].setRotationFromQuaternion(
                open_quaternion.slerp(fist_quaternion, t)
            )
        }
    }

    showHelper(scene) {
        this.hand_model.traverse((node) => {
            if (node.isMesh && node.skeleton) {
                const helper = new SkeletonHelper(node.skeleton.bones[0].parent)
                helper.material.linewidth = 3
                scene.add(helper)
                this.skeletonHelpers.push(helper)
            }
        })
    }
}
